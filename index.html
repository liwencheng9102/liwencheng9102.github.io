<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>雷电2</title>
    <div class="map">
        <div class="scoreboard">
            <h3>Game Over!</h3>
            <h5 class="historyscore">历史最高分：</h5>
            <span class="diescore">得分：0</span>
            <button class="reset">确定</button>
        </div>
    </div>
    <button id="begin">开始游戏</button>
    <span id="score">分数：0</span>
    <select id="function">
        <option value="1">鼠标</option>
        <option value="2">键盘</option>
    </select>
    <style>
        body {
            background: url('./imgs/bc.jpg') no-repeat;
            background-size: cover;
        }

        .map {
            width: 512px;
            height: 650px;
            margin: 5px auto;
            cursor: none;
            position: relative;
            overflow: hidden;
        }

        .scoreboard {
            width: 300px;
            height: 240px;
            background: rgba(245, 245, 245, 0.5);
            border: 1px solid blue;
            border-radius: 25%;
            text-align: center;
            position: absolute;
            left: 106px;
            top: 150px;
            z-index: 99;
            transform: scale(0);
            transition: all .3s;
        }

        .scoreboard .reset {
            width: 50px;
            height: 30px;
            font-size: 15px;
            font-weight: bold;
            border-radius: 25%;
            border: none;
            outline: none;
            cursor: pointer;
            color: #8aa0e9;
            background: rgba(245, 245, 245, 0.9);
            display: block;
            margin: 0 auto;
            margin-top: 20px;
        }

        .scoreboard h3,
        .scoreboard span,
        .scoreboard h5 {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        #begin {
            width: 100px;
            height: 50px;
            border: 1px solid black;
            border-radius: 25px;
            outline: none;
            background: rgb(24, 102, 190);
            float: left;
            font-size: 15px;
            cursor: pointer;
            position: absolute;
            top: 100px;
            left: 20px;
        }

        #begin:hover {
            background: lightblue;
        }

        #score {
            width: 100px;
            height: 50px;
            border: 1px solid black;
            border-radius: 25px;
            background: rgb(12, 93, 185);
            box-sizing: border-box;
            float: left;
            line-height: 50px;
            text-align: center;
            font-size: 15px;
            position: absolute;
            top: 20px;
            left: 20px;
        }

        #function {
            width: 100px;
            font-size: 15px;
            height: 50px;
            background: rgb(12, 93, 185);
            border-radius: 24px;
            padding: 0 10px;
            outline: none;
            border: none;
            position: absolute;
            top: 180px;
            left: 20px;
        }
    </style>
</head>

<body>
    <script>
        //创建地图 地图移动
        var x = 0;
        var map = document.getElementsByClassName("map")[0];
        var map_height = -756;
        var begin = document.getElementById('begin')
        var scoreBox = document.getElementById('score')
        var consoleFunction = document.getElementById('function')
        var scoreboard = document.getElementsByClassName('scoreboard')[0]
        var diescore = document.getElementsByClassName('diescore')[0]
        var historyscore = document.getElementsByClassName('historyscore')[0]
        var resetBtn = document.getElementsByClassName('reset')[0]

        var left = false;
        var right = false;
        var up = false;
        var down = false; //为了键盘控制设置的全局变量

        // map.style.background = 'url(imgs/bg.jpg) no-repeat 0' + map_height + "px"
        function map_move() {
            map_height += 5;
            if (map_height > 0) {
                map_height = -756;
            }
            map.style.background = 'url(imgs/bg.jpg) no-repeat 0' + map_height + "px";
        }

        //创建用户飞机 
        var user = new User(); //实例化的全局变量
        function User() {
            this.width = 106;
            this.height = 76;
            this.userf = null;
            this.x = 203;
            this.y = 569;
            this.scoring;
        }
        User.prototype.createUser = function () {
            // if (this.userf == null) {
            this.userf = document.createElement("img");
            this.userf.style.width = this.width + "px";
            this.userf.style.height = this.height + "px";
            this.userf.style.position = "absolute";
            // this.userf.style.zIndex = 1;
            this.userf.src = "./imgs/fj.png";
            this.userf.style.left = "204px";
            this.userf.style.bottom = "5px";
            map.appendChild(this.userf);
            // }
        }
        User.prototype.UsermouseMove = function (x, y) {
            this.x = x;
            this.y = y;
            this.userf.style.left = x + "px";
            this.userf.style.top = y + "px";
        }
        User.prototype.UserkeyboardMove = function () {
            time_keyboardMove = setInterval(function () {
                if (right) {
                    if (user.x < 400) {
                        user.x += 8
                         user.userf.style.left = user.x + 'px'
                    }
                } else if (left) {
                    if (user.x > 0) {
                        user.x -= 8
                        user.userf.style.left = user.x + 'px'
                    }
                } else if (up) {
                    if (user.y > 5) {
                        user.y -= 8
                        user.userf.style.top = user.y + 'px'
                    }
                } else if (down) {
                    if (user.y < 570) {
                        user.y += 8
                        user.userf.style.top = user.y + 'px'
                    }
                }
            }, 15)
        }

        // 创建子弹 
        var bullet = new Bullet();

        function Bullet() {
            this.width = 3;
            this.height = 17;
            this.bulletf = null;
            this.x;
            this.y;
        }
        Bullet.prototype.creatBullet = function () { //构造创建子弹的方法
            // if (this.bulletf == null) {
            this.bulletf = document.createElement("img");
            this.bulletf.style.width = this.width + "px";
            this.bulletf.style.height = this.height + "px";
            this.bulletf.style.position = "absolute";
            // this.bulletf.style.zIndex = 1;
            this.bulletf.src = "./imgs/paodan.png";
            map.appendChild(this.bulletf);
            //子弹坐标 x=飞机left+飞机自身的一半-子弹自身一半
            //y=飞机top-飞机自身的一半
            this.x = parseInt(user.userf.style.left) + user.width / 2 - this.width / 2;
            this.y = parseInt(user.userf.style.top) - user.height / 2 + 25;
            // }
        }
        Bullet.prototype.BulletMove = function (index, array) { //构造子弹移动的方法
            this.y -= 2; //子弹的top值
            if (this.y <= 0) { //当子弹飞出屏幕 移除创建的子弹及其实例化对象
                this.bulletf.remove();
                array.splice(index, 1); //移除实例化数组中的子弹 利用数组截取的方法
            }
            this.bulletf.style.left = this.x + "px";
            this.bulletf.style.top = this.y + "px";
        }
        Bullet.prototype.BulletEnemy = function (enemyarr, index, bulletarray) { //构造子弹打到敌机移除二者的方法
            for (var key in enemyarr) { //遍历敌机数组
                //判断 子弹x y 值范围在敌机区域 移除
                if (this.x > enemyarr[key].x && this.x < enemyarr[key].x + enemyarr[key].width &&
                    this.y > enemyarr[key].y - this.height && this.y < enemyarr[key].y + enemyarr[key].height) {
                    //大小敌机血量不同 当血量为0时  移除被击打的敌机及其实例化对象
                    enemyarr[key].blood -= 1;
                    if (enemyarr[key].blood <= 0) {
                        if (this.speed != 0) {
                            enemyarr[key].enemyf.src = './imgs/bz.gif';
                        }
                        // enemyarr[key].enemyf.remove();
                        // enemyarr.splice(key, 1);
                        enemyarr[key].speed = 0;
                        enemyarr[key].time = 10;

                        //记录分数
                        x += enemyarr[key].score;
                        user.scoring = x;
                        scoreBox.innerHTML = '分数：' + x;
                        diescore.innerHTML = '得分：' + x;

                        if (user.scoring > getCookie('topScore')) {
                            setCookie('topScore', user.scoring, 3)
                        }
                    }
                    this.bulletf.remove();
                    bulletarray.splice(index, 1);
                    //同时移除击打中敌机的子弹及实例化对象
                }
            }
        }

        //创建敌机
        var enemy = new Enemy();

        function Enemy(width, height, blood, score, s) {

            this.width = width;
            this.height = height;
            this.blood = blood;
            this.score = score;
            this.enemyf = null;
            this.src = s;
            this.speed = 2;
            this.x;
            this.y;
        }
        Enemy.prototype.createEnemy = function () {
            // if (this.enemyf == null) {
            this.enemyf = document.createElement("img");
            this.enemyf.style.width = this.width + "px";
            this.enemyf.style.height = this.height + "px";
            this.enemyf.style.position = "absolute";
            // this.enemyf.style.zIndex = 2;
            this.enemyf.src = this.src;
            map.appendChild(this.enemyf);
            //随机产生起始线不同位置的敌机
            this.x = Math.random() * (512 - this.width);
            this.y = -this.height;
            // }
            this.enemyf.style.left = this.x + "px";
            this.enemyf.style.top = this.y + "px";
        }
        Enemy.prototype.EnemyMove = function (index, array) {
            //改变敌机的top值 赋回去
            this.y += this.speed;
            if (this.y > 650) { //敌机飞出界面 移除创建的敌机及实例化对象
                // this.enemyf.remove();
                map.removeChild(this.enemyf);
                array.splice(index, 1); //移除实例化数组中的敌机 利用数组截取的方法
            }
            this.enemyf.style.top = this.y + "px";

            //在敌机下落过程中判断是否与飞机相撞 相撞游戏结束
            if (user.x > this.x - user.width + 15 && user.x < this.x + this.width - 15 &&
                user.y > this.y - user.height + 15 && user.y < this.y + this.height - 15) {
                // alert("Game over");
                scoreboard.style.transform = 'scale(1)';
                historyscore.innerHTML = '历史最高分：' + getCookie('topScore');
                clearInterval(time_creatBullet);
                clearInterval(time_BulletMove);
                clearInterval(time_createEnemy);
                clearInterval(time_EnemyMove);
                clearInterval(time_mapMove);
                clearInterval(time_keyboardMove);
                map.style.cursor = 'auto';
                map.onmousemove = null;
                // return;
            }
            //
            if (this.speed == 0 && this.blood <= 0 && this.time) {
                this.time--;
            }

            if (this.time <= 0) {
                for (var key in em_array) {
                    if (em_array[key].blood <= 0) {
                        em_array[key].enemyf.remove();
                        em_array.splice(key, 1);
                    }
                }
            }
        }

        //定义定时器变量
        var time_creatBullet;
        var time_BulletMove;
        var time_createEnemy;
        var time_EnemyMove;
        var time_mapMove
        var time_keyboardMove
        //定义存储子弹的数组  存储敌机的数组
        var bulletarr = [];
        var em_array = [];


        // 实例化子弹 调用创建方法
        function beginGame() {

            user.createUser();
            time_mapMove = setInterval('map_move()', 50); //移动地图

            time_creatBullet = setInterval(function () {
                bullet = new Bullet();
                bullet.creatBullet();
                bulletarr.push(bullet);
            }, 150);

            //调用子弹移动方法
            time_BulletMove = setInterval(function () {
                if (bulletarr.length > 0) {
                    for (var i = 0; i < bulletarr.length; i++) {
                        bulletarr[i].BulletMove(i, bulletarr);
                        if (em_array.length > 0) {
                            if (bulletarr[i] == undefined) return;
                            bulletarr[i].BulletEnemy(em_array, i, bulletarr);
                            // for (var key in em_array) {
                            //     if (em_array[key].time == undefined) {

                            //     }else{
                            //         return;
                            //     }
                            // }
                        }
                    }
                }
            }, 5);


            //实例化敌机 调用创建方法
            time_createEnemy = setInterval(function () {
                //利用随机数控制大小敌机创建比例
                // (width, height, blood, score, s)
                var random = Math.floor(Math.random() * 10)
                if (random > 7) {
                    enemy = new Enemy(116, 82, 7, 300, './imgs/dj1.png');
                    enemy.createEnemy();
                    em_array.push(enemy);
                } else if (random > 2) {
                    enemy = new Enemy(98, 76, 3, 100, './imgs/dj2.png');
                    enemy.createEnemy();
                    em_array.push(enemy);
                } else {
                    enemy = new Enemy(104, 74, 5, 200, './imgs/dj3.png');
                    enemy.createEnemy();
                    em_array.push(enemy);
                }
            }, 1000);
            //调用敌机移动方法
            time_EnemyMove = setInterval(function () {
                if (em_array.length > 0) {
                    for (var key in em_array) {
                        em_array[key].EnemyMove(key, em_array);
                    }
                }
            }, 15)


            if (consoleFunction.value == 1) {
                //创建地图鼠标移动事件 
                map.onmousemove = function (e) {
                    //鼠标位置-偏移量-用户飞机宽/高
                    var x = e.pageX - this.offsetLeft - user.width / 2;
                    var y = e.pageY - this.offsetTop - user.height / 2;
                    user.UsermouseMove(x, y);
                }
            } else if (consoleFunction.value == 2) {
                //键盘移动事件
                user.UserkeyboardMove();
                // 设置按键控制飞机方向
                document.onkeydown = function () {
                    switch (window.event.keyCode) {
                        case 37:
                            left = true;
                            break;
                        case 38:
                            up = true;
                            break;
                        case 39:
                            right = true;
                            break;
                        case 40:
                            down = true;
                            break;
                    }
                }
                document.onkeyup = function () {
                    switch (window.event.keyCode) {
                        case 37:
                            left = false;
                            break;
                        case 38:
                            up = false;
                            break;
                        case 39:
                            right = false;
                            break;
                        case 40:
                            down = false;
                            break;
                    }
                }
            }
        }

        //开始游戏
        begin.onclick = function () {
            beginGame()
        }

        //cookie

        function setCookie(key, value, exdays) {
            var d = new Date()
            d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000)
            document.cookie = key + '=' + value + ';' + "expires=" + d + ';path=/'
        }

        function getCookie(key) {
            var str = document.cookie
            var arr = str.split(';')
            var value
            for (var i = 0; i < arr.length; i++) {
                arr[i] = arr[i].trim()
            }
            var x = arr.filter(function (element) {
                return !element.indexOf(key)
            })
            if (x[0]) {
                value = x[0].slice(x[0].indexOf('=') + 1)
            } else {
                value = ''
            }
            return value
        }

        //重置
        function reset() {
            for (var i = 0; i < em_array.length; i++) {
                em_array[i].enemyf.remove()
                em_array.splice(i, 1);
            }
            for (var i = 0; i < bulletarr.length; i++) {
                bulletarr[i].bulletf.remove()
                bulletarr.splice(i, 1);
            }

            scoreboard.style.transform = 'scale(0)';
            map.removeChild(user.userf)
            user.x = 203;
            user.y = 569;
            user.scoring = 0;
            scoreBox.innerHTML = '分数：0';
            diescore.innerHTML = '得分：0';
            x = 0
        }
        resetBtn.onclick = function () {
            reset()
        }
    </script>
</body>

</html>