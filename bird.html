<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Flappy bird</title>
    <link href="./bootstrap/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./bootstrap/node_modules/bootstrap/dist/css/minireset.min.css">
    <link rel="stylesheet" href="./css/main.css">
</head>

<body>
    <nav class="navbar navbar-fixed-top navbar-inverse" style="background-color: rgba(0,0,0,0.6); border: none">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="./index.html">首页</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <form class="navbar-form navbar-right">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search">
                    </div>
                    <button type="submit" class="btn btn-default glyphicon glyphicon-search" style="top:0"></button>
                </form>
            </div><!-- /.navbar-collapse -->
        </div>
    </nav>
    <div id="wrap">
        <div id="Score"><span></span></div>
        <div id="title">
            <img src="img/head.jpg" />
            <div id="beginBird"></div>
        </div>
        <div id="beginBtn"></div>
        <div id="banner"></div>
        <div id="bird" class="birdAclinic"></div>
        <div class="box">
            <div id="gameover">
                <img src="./img/game_over.jpg" alt="">
            </div>
            <div id="message">
                <span id="dieScore">0</span>
                <span id="history">0</span>
            </div>
            <div>
                <img id="ok" src="./img/ok.jpg" alt="">
            </div>
        </div>
    </div>
</body>
 <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
 <script src="./bootstrap/node_modules/bootstrap/dist/js/jquery.min.js"></script>
 <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
 <script src="./bootstrap/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script>
    var wrap = document.getElementById('wrap');
    var beginBtn = document.getElementById('beginBtn');
    var title = document.getElementById('title')
    var banner = document.getElementById('banner')
    var birdBox = document.getElementById('bird');
    var scoreBox = document.getElementById('Score');
    var span = document.querySelector('span')
    var box = document.getElementsByClassName('box')[0];
    var ok = document.getElementById('ok')
    var dieScore = document.getElementById('dieScore')
    var best = document.getElementById('history')

    var banner_left = 0;

    function bannerMove() {
        banner_left -= 2;
        if (banner_left <= -343) {
            banner_left = 0;
        }
        banner.style.background = 'url(./img/slider.jpg)' + banner_left + 'px 0';
    }

    var bird = new Bird();

    function Bird() {
        this.speed = 0;
        this.scoring = 0;
        this.offTop;
    }
    Bird.prototype.move = function () {
        this.speed -= 1
        if (this.speed > 0) {
            birdBox.className = 'birdUp'
        } else if (this.speed == 0) {
            birdBox.className = 'birdAclinic'
        } else if (this.speed < 0) {
            birdBox.className = 'birdDown'
        }
        this.offTop = birdBox.offsetTop - this.speed;
        birdBox.style.top = this.offTop + 'px';
        if (this.offTop > 393 || this.offTop < 0) {
            // debugger
            box.style.transform = 'scale(1)'
            clearInterval(bannerMove_time)
            clearInterval(birdMove_time)
            clearInterval(ductCreat_time)
            clearInterval(ductMove_time)
        }
    }
    Bird.prototype.collision = function (array) {
        for (var key in array) {

            var upDot_top = parseInt(getComputedStyle(array[key].upDuct).height)
            var upDot_left = parseInt(getComputedStyle(array[key].ductBox).left)
            var downDot_top = 423 - parseInt(getComputedStyle(array[key].downDuct).height)
            if ((70 > upDot_left && this.offTop < upDot_top && 70 < upDot_left + 62 + 35) || (70 > upDot_left &&
                    this.offTop + 30 > downDot_top && 70 < upDot_left + 62 + 35)) {
                // debugger
                box.style.transform = 'scale(1)'
                clearInterval(bannerMove_time)
                clearInterval(birdMove_time)
                clearInterval(ductCreat_time)
                clearInterval(ductMove_time)
            }
        }
    }

    var duct;

    function Duct() {
        this.score = 1;
        this.ductBox
        this.left = 343
        this.speed = 2
        this.upDuct
        this.downDuct
    }
    Duct.prototype.creat = function () {
        this.ductBox = document.createElement('div')
        this.ductBox.className = 'duct'
        wrap.appendChild(this.ductBox)

        //上管道
        this.upDuct = document.createElement('div')
        this.upDuct.className = 'upduct'
        var randomHeight
        var okNum = false
        while (!okNum) {
            okNum = true
            randomHeight = Math.random() * 263
            if (randomHeight < 60) {
                okNum = false
            }
        }

        this.upDuct.style.height = randomHeight + 'px'
        this.ductBox.appendChild(this.upDuct)
        var upImg = document.createElement('img')
        upImg.src = './img/up_pipe.png'
        this.upDuct.appendChild(upImg)

        //下管道
        this.downDuct = document.createElement('div')
        this.downDuct.className = 'downduct'
        this.downDuct.style.height = 323 - this.upDuct.offsetHeight + "px"
        this.ductBox.appendChild(this.downDuct)
        var downImg = document.createElement('img')
        downImg.src = './img/down_pipe.png'
        this.downDuct.appendChild(downImg)
    }
    Duct.prototype.move = function (index, array) {
        // debugger
        // if (bird.scoring>5) {
        //     this.speed=4
        // }else if(bird.scoring>10){
        //     this.speed=6
        // }
        this.left -= this.speed;
        this.ductBox.style.left = this.left + 'px'
        if (this.left < -62) { //出界 移除创建的管道及实例化对象
            wrap.removeChild(this.ductBox);
            array.splice(index, 1); //移除实例化数组中的管道 利用数组截取的方法
            //记录分数
            bird.scoring += this.score;
            dieScore.innerHTML = bird.scoring
            if (bird.scoring > getCookie('topScore')) {
                setCookie('topScore', bird.scoring, 3)
            }
            best.innerHTML = parseInt(getCookie('topScore'))
            if (bird.scoring < 10) {
                scoreBox.style.background = 'url(./img/' + bird.scoring + '.jpg)';
            } else if (bird.scoring >= 10) {
                scoreBox.style.background = 'none'
                span.innerHTML = bird.scoring
            }
        }
    }

    //游戏开始
    var bannerMove_time
    var birdMove_time
    var ductCreat_time
    var ductMove_time
    var ductarr = []
    beginBtn.onclick = function (e) {
        e.stopPropagation()
        wrap.appendChild(birdBox)
        birdBox.style.display = 'block'
        beginBtn.style.display = 'none'
        title.style.display = 'none'

        bannerMove_time = setInterval(function () {
            bannerMove()
        }, 20)

        birdMove_time = setInterval(function () {
            bird.move()
            bird.collision(ductarr)
        }, 50)

        ductCreat_time = setInterval(function () {
            duct = new Duct();
            duct.creat();
            ductarr.push(duct);
        }, 3000)
        ductMove_time = setInterval(function () {
            if (ductarr.length > 0) {
                for (var key in ductarr) {
                    ductarr[key].move(key, ductarr);
                }
            }
        }, 20)
    }
    document.onclick = function () {
        bird.speed = 8
    }
    document.ontouchstart = function () {
        bird.speed = 8
    }
    //重置按钮
    function reset(array) {
        for (var key in array) {
            array[key].ductBox.remove();
            array.splice(key, 1);
        }
        box.style.transform = 'scale(0)'
        bird.speed = 0
        bird.scoring = 0
        birdBox.style.top = '100px'
        wrap.removeChild(birdBox)
        //移除旧鸟 

        birdBox.style.display = 'block'
        beginBtn.style.display = 'block'
        title.style.display = 'block'

        //分数重置
        dieScore.innerHTML = 0
        scoreBox.style.background = 'url(./img/0.jpg)'
        span.innerHTML = ''
    }
    ok.onclick = function (e) {
        e.stopPropagation()
        reset(ductarr)
    }

    //cookie
    function setCookie(key, value, exdays) {
        var d = new Date()
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000)
        document.cookie = key + '=' + value + ';' + "expires=" + d + ';path=/'
    }
    setCookie('topScore', 0, 3)

    function getCookie(key) {
        var str = document.cookie
        var arr = str.split(';')
        var value
        for (var i = 0; i < arr.length; i++) {
            arr[i] = arr[i].trim()
        }
        var x = arr.filter(function (element) {
            return !element.indexOf(key)
        })
        if (x[0]) {
            value = x[0].slice(x[0].indexOf('=') + 1)
        } else {
            value = ''
        }
        return value
    }
</script>

</html>